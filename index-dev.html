<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Application - Dev Environment</title>
    <style>
      /* Dialog Styles */
      #form-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
      }

      .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dialog-content {
        background: white;
        border-radius: 12px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .dialog-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .dialog-title-large {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #111827;
      }

      .dialog-message {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.6;
      }

      .dialog-message-large {
        font-size: 18px;
        color: #4b5563;
        margin-bottom: 32px;
        line-height: 1.6;
      }

      .dialog-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .dialog-button {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
      }

      .dialog-button-primary {
        background: #3b82f6;
        color: white;
      }

      .dialog-button-primary:hover {
        background: #2563eb;
      }

      .dialog-button-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .dialog-button-secondary:hover {
        background: #e5e7eb;
      }

      .dialog-button-success {
        background: #10b981;
        color: white;
      }

      .dialog-button-success:hover {
        background: #059669;
      }

      .dialog-icon-container {
        margin: 0 auto 24px auto;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .success-icon-container {
        background: #d1fae5;
      }

      .error-icon-container {
        background: #fee2e2;
      }

      .dialog-icon {
        width: 32px;
        height: 32px;
      }

      .success-icon {
        color: #10b981;
      }

      .error-icon {
        color: #ef4444;
      }

      .success-dialog .dialog-title-large {
        color: #065f46;
      }

      .error-dialog .dialog-title-large {
        color: #991b1b;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-details {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
        text-align: left;
      }

      .error-details-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
      }

      /* Form container styles */
      .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div
        id="form-wrapper"
        data-form-id="76438228-4767-f011-bec2-00224809e97b"
        data-form-api-url="https://public-usa.mkt.dynamics.com/api/v1.0/orgs/14e74438-32ad-42c2-91eb-3b40da498c56/landingpageforms"
        data-cached-form-url="https://assets-usa.mkt.dynamics.com/14e74438-32ad-42c2-91eb-3b40da498c56/digitalassets/forms/76438228-4767-f011-bec2-00224809e97b"
      ></div>
    </div>

    <script>
      // Configuration for form submission
      const formConfig = {
        formId: "76438228-4767-f011-bec2-00224809e97b",
        orgId: "14e74438-32ad-42c2-91eb-3b40da498c56",
        baseUrl: "https://public-usa.mkt.dynamics.com/api/v1.0",
        successRedirectUrl:
          "https://client-connect-core.powerappsportals.com/SignIn",
        contactSupportUrl: "https://www.acesaba.com/contact",
      };

      // Unified messages object containing all dialog messages
      const messages = {
        progress: {
          title: "Processing Your Information",
          message:
            "Please wait while we verify your information. This may take a few moments.",
        },
        success: {
          title: "Success!",
          message:
            "Awesome! We provide services in your area. Login using {userEmail} to continue with application process. Redirecting to login page...",
          buttonText: "Continue to Login",
        },
        confirmation: {
          title: "Confirm Information",
          message:
            "Are you sure you want to submit this information? Please review your information before proceeding.",
          confirmText: "Yes, Submit",
          cancelText: "Cancel",
        },
        rejection: {
          title: "Submission Cancelled",
          message:
            "Your submission has been cancelled. You can make changes and try again.",
          buttonText: "OK",
        },
        errors: {
          payer_not_found: {
            title: "Insurance Provider Not Found",
            description:
              "We couldn't find your insurance provider in our system. Our support team will contact you to assist with your eligibility.",
            details: null,
          },
          eligibility_diagnosis_not_found: {
            title: "Diagnosis Not Eligible",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
          zip_code_not_found: {
            title: "Service Area Not Available",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
          network_error: {
            title: "Connection Problem",
            description:
              "There was a network error while submitting your information. Please try submitting again.",
            details: null,
          },
          unexpected_error: {
            title: "Unexpected Error",
            description:
              "An unexpected error occurred while processing your submission. Please try submitting again.",
            details: null,
          },
          unknown_error: {
            title: "Submission Error",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
        },
        buttons: {
          tryAgain: "Try Again",
          contactSupport: "Contact Support",
        },
      };

      // Fetch function with proper error handling
      const formFetch = async (payload) => {
        const url = `${formConfig.baseUrl}/orgs/${formConfig.orgId}/landingpageforms/forms/${formConfig.formId}`;

        const requestOptions = {
          headers: {
            accept: "application/json",
            "cache-control": "no-cache",
            "content-type": "application/json",
          },
          body: JSON.stringify(payload),
          method: "POST",
          mode: "cors",
          credentials: "omit",
        };

        try {
          const response = await fetch(url, requestOptions);

          if (response.ok) {
            return {
              success: true,
              data: await response.json().catch(() => ({})),
            };
          }

          // Handle specific HTTP status codes
          if (response.status === 400) {
            const errorData = await response.json().catch(() => ({}));
            return {
              success: false,
              error: "validation_error",
              status: 400,
              data: errorData,
            };
          }

          if (response.status === 500) {
            const errorText = await response.text().catch(() => '{}');
            let errorData = {};
            try {
              errorData = JSON.parse(errorText);
            } catch (parseError) {
              errorData = { Message: errorText };
            }
            return {
              success: false,
              error: "server_error",
              status: 500,
              data: errorData,
            };
          }

          return {
            success: false,
            error: "http_error",
            status: response.status,
            statusText: response.statusText,
          };
        } catch (error) {
          return {
            success: false,
            error: "network_error",
            message: error.message,
          };
        }
      };

      // Process payor field and update lookup text
      const processPayorField = (payload) => {
        const aces_payor = payload.fields.find(
          (item) => item.key === "aces_payor",
        );

        if (aces_payor) {
          const acesPayorValue = `account,${aces_payor.value}`;
          const payorListItem = document.querySelector(
            `li.ui-menu-item[data-value='${CSS.escape(acesPayorValue)}']`,
          );
          const payorRelationship = payorListItem?.querySelector(
            ".ui-menu-item-wrapper",
          )?.textContent;

          const payorLookupField = payload.fields.find(
            (item) => item.key === "aces_payorlookuptext",
          );
          if (payorLookupField) {
            payorLookupField.value = payorRelationship;
          }
        }
      };

      // Process caregiver relationship field and update lookup text
      const processCaregiverField = (payload) => {
        const aces_startherecaregiverrelationship = payload.fields.find(
          (item) => item.key === "aces_startherecaregiverrelationship",
        );

        if (aces_startherecaregiverrelationship) {
          const acesCaregiverValue = `msemr_codeableconcept,${aces_startherecaregiverrelationship.value}`;
          const caregiverListItem = document.querySelector(
            `li.ui-menu-item[data-value='${CSS.escape(acesCaregiverValue)}']`,
          );
          const caregiverRelationship = caregiverListItem?.querySelector(
            ".ui-menu-item-wrapper",
          )?.textContent;

          const relationshipLookupField = payload.fields.find(
            (item) => item.key === "aces_relationshiplookuptext",
          );
          if (relationshipLookupField) {
            relationshipLookupField.value = caregiverRelationship;
          }
        }
      };

      // Utility functions for dialog management
      const removeExistingDialog = () => {
        const existingDialog = document.getElementById("form-dialog");
        if (existingDialog) {
          existingDialog.remove();
        }
      };

      const createDialogElement = (content) => {
        const dialog = document.createElement("div");
        dialog.id = "form-dialog";
        dialog.innerHTML = `<div class="dialog-overlay"><div class="dialog-content">${content}</div></div>`;
        return dialog;
      };

      const createIcon = (type) => {
        const icons = {
          success:
            '<svg class="dialog-icon success-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>',
          error:
            '<svg class="dialog-icon error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>',
          spinner: '<div class="spinner"></div>',
          errorIcon: '<div class="error-icon"></div>',
        };
        return icons[type] || "";
      };

      const createButtons = (buttons) => {
        if (!buttons || buttons.length === 0) return "";

        const buttonElements = buttons
          .map(
            (btn) =>
              `<button ${btn.id ? `id="${btn.id}"` : ""} ${
                btn.onclick ? `onclick="${btn.onclick}"` : ""
              } class="dialog-button ${
                btn.className || "dialog-button-primary"
              }">${btn.text}</button>`,
          )
          .join("");

        return `<div class="dialog-buttons">${buttonElements}</div>`;
      };

      const showDialog = (config) => {
        removeExistingDialog();

        const iconHtml = config.icon
          ? `<div class="dialog-icon-container ${
              config.iconContainer || ""
            }">${createIcon(config.icon)}</div>`
          : "";
        const titleHtml = config.title
          ? `<${config.titleTag || "div"} class="${
              config.titleClass || "dialog-title"
            }">${iconHtml}${config.title}</${config.titleTag || "div"}>`
          : "";
        const messageHtml = config.message
          ? `<p class="${config.messageClass || "dialog-message"}">${
              config.message
            }</p>`
          : "";
        const detailsHtml = config.details || "";
        const buttonsHtml = createButtons(config.buttons);

        const content = `${
          config.dialogClass ? `<div class="${config.dialogClass}">` : ""
        }${titleHtml}${messageHtml}${detailsHtml}${buttonsHtml}${
          config.dialogClass ? "</div>" : ""
        }`;

        const dialog = createDialogElement(content);
        document.body.appendChild(dialog);

        return dialog;
      };

      // Optimized dialog functions using shared utilities
      const showProgressDialog = () => {
        showDialog({
          title: messages.progress.title,
          message: messages.progress.message,
          icon: "spinner",
        });
      };

      const showSuccessMessage = (payload) => {
        const emailField = payload?.fields?.find(
          (field) => field.key === "emailaddress1",
        );
        const userEmail = emailField?.value || "abc@xyz.com";

        const url = new URL(formConfig.successRedirectUrl);
        url.searchParams.set("preQualEmail", userEmail);
        const redirectUrl = url.toString();

        const successMessage = messages.success.message.replace(
          "{userEmail}",
          userEmail,
        );

        showDialog({
          dialogClass: "success-dialog",
          title: messages.success.title,
          titleTag: "h1",
          titleClass: "dialog-title-large",
          message: successMessage,
          messageClass: "dialog-message-large",
          icon: "success",
          iconContainer: "success-icon-container",
          buttons: [
            {
              text: messages.success.buttonText,
              onclick: `window.location.href='${redirectUrl}'`,
              className: "dialog-button-success",
            },
          ],
        });
      };

      const showErrorMessage = (errorCode = "unknown_error", dynamicContent = null) => {
        let errorInfo;
        
        // Prioritize dynamic content from server response
        if (dynamicContent && dynamicContent.Message) {
          errorInfo = {
            title: dynamicContent.title || "Application Status",
            description: dynamicContent.Message,
            details: null,
          };
        } else {
          // Only use hardcoded messages for network/unexpected errors
          errorInfo = messages.errors[errorCode] || messages.errors.unknown_error;
        }
        
        const detailsHtml = errorInfo.details
          ? `<div class="error-details"><h3 class="error-details-title">What you can do:</h3><div>${errorInfo.details}</div></div>`
          : "";

        // Use button text from server response or fallback to default
        const buttonText = (dynamicContent && dynamicContent.buttonText) || messages.buttons.tryAgain;

        showDialog({
          dialogClass: "error-dialog",
          title: errorInfo.title,
          titleTag: "h1",
          titleClass: "dialog-title-large",
          message: errorInfo.description,
          messageClass: "dialog-message-large",
          icon: "error",
          iconContainer: "error-icon-container",
          details: detailsHtml,
          buttons: [
            {
              text: buttonText,
              onclick: "document.getElementById('form-dialog').remove()",
              className: "dialog-button-primary",
            },
            {
              text: messages.buttons.contactSupport,
              onclick: `window.location.href='${formConfig.contactSupportUrl}'`,
              className: "dialog-button-secondary",
            },
          ],
        });
      };

      const showRejectionMessage = () => {
        showDialog({
          title: messages.rejection.title,
          message: messages.rejection.message,
          icon: "errorIcon",
          buttons: [
            {
              text: messages.rejection.buttonText,
              onclick: "document.getElementById('form-dialog').remove()",
              className: "dialog-button-secondary",
            },
          ],
        });
      };

      const showConfirmationDialog = () => {
        return new Promise((resolve) => {
          showDialog({
            title: messages.confirmation.title,
            message: messages.confirmation.message,
            buttons: [
              {
                id: "confirm-yes",
                text: messages.confirmation.confirmText,
                className: "dialog-button-primary",
              },
              {
                id: "confirm-no",
                text: messages.confirmation.cancelText,
                className: "dialog-button-secondary",
              },
            ],
          });

          document
            .getElementById("confirm-yes")
            .addEventListener("click", () => resolve(true));
          document
            .getElementById("confirm-no")
            .addEventListener("click", () => resolve(false));
        });
      };

      // Handle form submission with complete processing logic
      const submitFormHandler = async (payload) => {
        // Show confirmation dialog
        const confirmed = await showConfirmationDialog();

        if (!confirmed) {
          showRejectionMessage();
          return;
        }

        // Show progress dialog
        showProgressDialog();

        // Process form fields using extracted functions
        processPayorField(payload);
        processCaregiverField(payload);

        const acesIseligiblediagnosis = payload.fields.find(
          (item) => item.key === "aces_iseligiblediagnosis",
        );

        const acesPayorfound = payload.fields.find(
          (item) => item.key === "aces_payorfound",
        );

        // Use the enhanced fetch function
        try {
          const result = await formFetch(payload);
          if (result.success) {
            showSuccessMessage(payload);
          } else {
            let errorCode = "";
            if (result.status === 400) {
              if (acesPayorfound && acesPayorfound.value === "0") {
                errorCode = "payer_not_found";
              } else if (
                acesIseligiblediagnosis &&
                acesIseligiblediagnosis.value === "0"
              ) {
                errorCode = "eligibility_diagnosis_not_found";
              } else {
                errorCode = "zip_code_not_found";
              }
              showErrorMessage(errorCode);
            } else if (result.status === 500 && result.data) {
              // Handle 500 errors with dynamic content from server
              showErrorMessage("server_error", result.data);
            } else {
              // Fallback for other errors
              showErrorMessage("unknown_error");
            }
          }
        } catch (error) {
          console.error("Unexpected error during form submission:", error);

          // Wait for at least 3 seconds before showing error
          await new Promise((resolve) => setTimeout(resolve, 3000));

          // Show error dialog instead of redirecting
          showErrorMessage("unexpected_error");
        }
      };

      // Make functions available globally for the event handlers
      window.formFetch = formFetch;
      window.processPayorField = processPayorField;
      window.processCaregiverField = processCaregiverField;
      window.submitFormHandler = submitFormHandler;
      window.showConfirmationDialog = showConfirmationDialog;
      window.showProgressDialog = showProgressDialog;
      window.showSuccessMessage = showSuccessMessage;
      window.showErrorMessage = showErrorMessage;
      window.showRejectionMessage = showRejectionMessage;

      // Event listeners for form lifecycle events
      document.addEventListener("d365mkt-beforeformload", function () {});

      document.addEventListener("d365mkt-afterformload", function () {
        // Add custom validation to email field
        const emailField = document.querySelector('input[type="email"]');
        if (emailField) {
          emailField.setAttribute(
            "oninvalid",
            "setCustomValidity('Please enter valid email address.')",
          );
          emailField.setAttribute("oninput", "setCustomValidity('')");
        }

        // Add phone validation and pattern to tel fields
        const phoneFields = document.querySelectorAll('input[type="tel"]');
        phoneFields.forEach((phoneField) => {
          // Set a more flexible pattern that allows common US phone number formats
          phoneField.setAttribute(
            "pattern",
            "^(\\+?1[-. ]?)?\\(?[2-9][0-9]{2}\\)?[-. ]?[2-9][0-9]{2}[-. ]?[0-9]{4}$|^[2-9][0-9]{9}$"
          );
          phoneField.setAttribute(
            "title",
            "Please enter a valid US phone number (e.g., 5551234567, (555) 123-4567, 555-123-4567, or 555.123.4567)"
          );
          
          // Clear custom validity on input to allow revalidation
          phoneField.addEventListener('input', function(e) {
            // Allow only digits, spaces, hyphens, dots, parentheses, and plus sign
            const value = e.target.value.replace(/[^0-9\s\-\.\(\)\+]/g, '');
            if (e.target.value !== value) {
              e.target.value = value;
            }
            
            // Reset custom validity to allow HTML5 validation to work
            e.target.setCustomValidity('');
          });
          
          // Set custom validity message on invalid event
          phoneField.addEventListener('invalid', function(e) {
            e.target.setCustomValidity('Please enter a valid US phone number (e.g., 5551234567, (555) 123-4567, or 555-123-4567)');
          });
          
          // Validate on blur for immediate feedback
          phoneField.addEventListener('blur', function(e) {
            if (e.target.value) {
              const pattern = /^((\+?1[-. ]?)?\(?[2-9][0-9]{2}\)?[-. ]?[2-9][0-9]{2}[-. ]?[0-9]{4})|([2-9][0-9]{9})$/;
              if (!pattern.test(e.target.value)) {
                e.target.setCustomValidity('Please enter a valid US phone number (e.g., 5551234567, (555) 123-4567, or 555-123-4567)');
                e.target.reportValidity();
              } else {
                e.target.setCustomValidity('');
              }
            }
          });
          
          // Prevent non-numeric keys from being pressed (except formatting characters)
          phoneField.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            // Allow numbers, space, dash, dot, parentheses, plus, backspace, delete, arrow keys
            if (!/[0-9\s\-\.\(\)\+]/.test(char) && !e.ctrlKey && !e.metaKey && e.keyCode !== 8 && e.keyCode !== 46) {
              e.preventDefault();
            }
          });
        });
      });

      document.addEventListener("d365mkt-formrender", function () {});

      document.addEventListener("d365mkt-formsubmit", function (event) {
        event.preventDefault();
        submitFormHandler(event.detail.payload);
      });

      document.addEventListener("d365mkt-afterformsubmit", function () {});

      // Load the FormLoader script
      const script = document.createElement("script");
      script.src =
        "https://cxppusa1formui01cdnsa01-endpoint.azureedge.net/usa/FormLoader/FormLoader.bundle.js";
      script.defer = true;
      document.head.appendChild(script);
    </script>
  </body>
</html>
