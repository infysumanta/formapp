<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Application - Test Environment</title>
    <style>
      /* Dialog Styles */
      #form-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
      }

      .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dialog-content {
        background: white;
        border-radius: 12px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .dialog-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .dialog-title-large {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #111827;
      }

      .dialog-message {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.6;
      }

      .dialog-message-large {
        font-size: 18px;
        color: #4b5563;
        margin-bottom: 32px;
        line-height: 1.6;
      }

      .dialog-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .dialog-button {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
      }

      .dialog-button-primary {
        background: #3b82f6;
        color: white;
      }

      .dialog-button-primary:hover {
        background: #2563eb;
      }

      .dialog-button-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .dialog-button-secondary:hover {
        background: #e5e7eb;
      }

      .dialog-button-success {
        background: #10b981;
        color: white;
      }

      .dialog-button-success:hover {
        background: #059669;
      }

      .dialog-icon-container {
        margin: 0 auto 24px auto;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .success-icon-container {
        background: #d1fae5;
      }

      .error-icon-container {
        background: #fee2e2;
      }

      .dialog-icon {
        width: 32px;
        height: 32px;
      }

      .success-icon {
        color: #10b981;
      }

      .error-icon {
        color: #ef4444;
      }

      .success-dialog .dialog-title-large {
        color: #065f46;
      }

      .error-dialog .dialog-title-large {
        color: #991b1b;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-details {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
        text-align: left;
      }

      .error-details-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
      }

      /* Form container styles */
      .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div
        id="form-wrapper"
        data-form-id="d3630a02-b871-f011-b4cc-6045bd019ae9"
        data-form-api-url="https://public-usa.mkt.dynamics.com/api/v1.0/orgs/22995153-1e26-409d-a380-d58e92c7e210/landingpageforms"
        data-cached-form-url="https://assets-usa.mkt.dynamics.com/22995153-1e26-409d-a380-d58e92c7e210/digitalassets/forms/d3630a02-b871-f011-b4cc-6045bd019ae9"
      ></div>
    </div>

    <script>
      // Configuration for form submission
      const formConfig = {
        formId: "d3630a02-b871-f011-b4cc-6045bd019ae9",
        orgId: "22995153-1e26-409d-a380-d58e92c7e210",
        baseUrl: "https://public-usa.mkt.dynamics.com/api/v1.0",
        successRedirectUrl: "https://client-connect-test.powerappsportals.com/",
      };

      // Unified messages object containing all dialog messages
      const messages = {
        progress: {
          title: "Processing Your Information",
          message:
            "Please wait while we verify your information. This may take a few moments.",
        },
        success: {
          title: "Success!",
          message:
            "Awesome! We provide services in your area. Login using {userEmail} to continue with application process. Redirecting to login page...",
          buttonText: "Continue to Login",
        },
        confirmation: {
          title: "Confirm Information",
          message:
            "Are you sure you want to submit this information? Please review your information before proceeding.",
          confirmText: "Yes, Submit",
          cancelText: "Cancel",
        },
        rejection: {
          title: "Submission Cancelled",
          message:
            "Your submission has been cancelled. You can make changes and try again.",
          buttonText: "OK",
        },
        errors: {
          payer_not_found: {
            title: "Insurance Provider Not Found",
            description:
              "We couldn't find your insurance provider in our system. Our support team will contact you to assist with your eligibility.",
            details: null,
          },
          eligibility_diagnosis_not_found: {
            title: "Diagnosis Not Eligible",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
          zip_code_not_found: {
            title: "Service Area Not Available",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
          network_error: {
            title: "Connection Problem",
            description:
              "There was a network error while submitting your information. Please try submitting again.",
            details: null,
          },
          unexpected_error: {
            title: "Unexpected Error",
            description:
              "An unexpected error occurred while processing your submission. Please try submitting again.",
            details: null,
          },
          unknown_error: {
            title: "Submission Error",
            description:
              "Your application is under review. Our support team will contact you to discuss your options.",
            details: null,
          },
        },
        buttons: {
          tryAgain: "Try Again",
          contactSupport: "Contact Support",
        },
      };

      // Fetch function with proper error handling
      const formFetch = async (payload) => {
        const url = `${formConfig.baseUrl}/orgs/${formConfig.orgId}/landingpageforms/forms/${formConfig.formId}`;

        const requestOptions = {
          headers: {
            accept: "application/json",
            "cache-control": "no-cache",
            "content-type": "application/json",
          },
          body: JSON.stringify(payload),
          method: "POST",
          mode: "cors",
          credentials: "omit",
        };

        try {
          const response = await fetch(url, requestOptions);

          if (response.ok) {
            return {
              success: true,
              data: await response.json().catch(() => ({})),
            };
          }

          // Handle specific HTTP status codes
          if (response.status === 400) {
            const errorData = await response.json().catch(() => ({}));
            return {
              success: false,
              error: "validation_error",
              status: 400,
              data: errorData,
            };
          }

          return {
            success: false,
            error: "http_error",
            status: response.status,
            statusText: response.statusText,
          };
        } catch (error) {
          return {
            success: false,
            error: "network_error",
            message: error.message,
          };
        }
      };

      // Process payor field and update lookup text
      const processPayorField = (payload) => {
        const aces_payor = payload.fields.find(
          (item) => item.key === "aces_payor",
        );

        if (aces_payor) {
          const acesPayorValue = `account,${aces_payor.value}`;
          console.log("acesPayorValue", acesPayorValue);
          const payorListItem = document.querySelector(
            `li.ui-menu-item[data-value='${CSS.escape(acesPayorValue)}']`,
          );
          const payorRelationship = payorListItem?.querySelector(
            ".ui-menu-item-wrapper",
          )?.textContent;

          const payorLookupField = payload.fields.find(
            (item) => item.key === "aces_payorlookuptext",
          );
          if (payorLookupField) {
            payorLookupField.value = payorRelationship;
          }
        }
      };

      // Process caregiver relationship field and update lookup text
      const processCaregiverField = (payload) => {
        const aces_startherecaregiverrelationship = payload.fields.find(
          (item) => item.key === "aces_startherecaregiverrelationship",
        );

        if (aces_startherecaregiverrelationship) {
          const acesCaregiverValue = `msemr_codeableconcept,${aces_startherecaregiverrelationship.value}`;
          console.log("acesCaregiverValue", acesCaregiverValue);
          const caregiverListItem = document.querySelector(
            `li.ui-menu-item[data-value='${CSS.escape(acesCaregiverValue)}']`,
          );
          const caregiverRelationship = caregiverListItem?.querySelector(
            ".ui-menu-item-wrapper",
          )?.textContent;

          const relationshipLookupField = payload.fields.find(
            (item) => item.key === "aces_relationshiplookuptext",
          );
          if (relationshipLookupField) {
            relationshipLookupField.value = caregiverRelationship;
          }
        }
      };

      // Show progress dialog
      const showProgressDialog = () => {
        // Remove any existing dialog
        const existingDialog = document.getElementById("form-dialog");
        if (existingDialog) {
          existingDialog.remove();
        }

        // Create progress dialog
        const dialog = document.createElement("div");
        dialog.id = "form-dialog";
        dialog.innerHTML = `
                <div class="dialog-overlay">
                    <div class="dialog-content">
                        <div class="dialog-title">
                            <div class="spinner"></div>
                            ${messages.progress.title}
                        </div>
                        <p class="dialog-message">${messages.progress.message}</p>
                    </div>
                </div>
            `;
        document.body.appendChild(dialog);
      };

      // Enhanced success message
      const showSuccessMessage = (payload) => {
        // Remove existing dialog
        const existingDialog = document.getElementById("form-dialog");
        if (existingDialog) {
          existingDialog.remove();
        }

        // Extract email from payload and construct proper URL
        const emailField = payload?.fields?.find(
          (field) => field.key === "emailaddress1",
        );
        const userEmail = emailField?.value || "abc@xyz.com";

        const url = new URL(formConfig.successRedirectUrl);
        url.searchParams.set("preQualEmail", userEmail);
        const redirectUrl = url.toString();

        // Create success dialog with dynamic email replacement
        const successMessage = messages.success.message.replace(
          "{userEmail}",
          userEmail,
        );
        const dialog = document.createElement("div");
        dialog.id = "form-dialog";
        dialog.innerHTML = `
                <div class="dialog-overlay">
                    <div class="dialog-content success-dialog">
                        <div class="dialog-icon-container success-icon-container">
                            <svg class="dialog-icon success-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h1 class="dialog-title-large">${messages.success.title}</h1>
                        <p class="dialog-message-large">${successMessage}</p>
                        <div class="dialog-buttons">
                            <button onclick="window.location.href='${redirectUrl}'" class="dialog-button dialog-button-success">
                                ${messages.success.buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(dialog);
      };

      // Enhanced error message with specific error handling
      const showErrorMessage = (errorCode = "unknown_error") => {
        // Remove existing dialog
        const existingDialog = document.getElementById("form-dialog");
        if (existingDialog) {
          existingDialog.remove();
        }

        const errorInfo =
          messages.errors[errorCode] || messages.errors.unknown_error;

        // Create error dialog
        const dialog = document.createElement("div");
        dialog.id = "form-dialog";
        dialog.innerHTML = `
                <div class="dialog-overlay">
                    <div class="dialog-content error-dialog">
                        <div class="dialog-icon-container error-icon-container">
                            <svg class="dialog-icon error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <h1 class="dialog-title-large">${errorInfo.title}</h1>
                        <p class="dialog-message-large">${
                          errorInfo.description
                        }</p>
                        ${
                          errorInfo.details
                            ? `<div class="error-details">
                            <h3 class="error-details-title">What you can do:</h3>
                            <div>${errorInfo.details}</div>
                        </div>`
                            : ""
                        }
                        <div class="dialog-buttons">
                            <button onclick="document.getElementById('form-dialog').remove()" class="dialog-button dialog-button-primary">
                                ${messages.buttons.tryAgain}
                            </button>
                            <button onclick="window.location.href='mailto:support@example.com?subject=Form Submission Error&body=Error Code: ${errorCode}'" class="dialog-button dialog-button-secondary">
                                ${messages.buttons.contactSupport}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(dialog);
      };

      // Show rejection message
      const showRejectionMessage = () => {
        // Remove existing dialog
        const existingDialog = document.getElementById("form-dialog");
        if (existingDialog) {
          existingDialog.remove();
        }

        // Create rejection dialog
        const dialog = document.createElement("div");
        dialog.id = "form-dialog";
        dialog.innerHTML = `
                <div class="dialog-overlay">
                    <div class="dialog-content">
                        <div class="dialog-title">
                            <div class="error-icon"></div>
                            ${messages.rejection.title}
                        </div>
                        <p class="dialog-message">${messages.rejection.message}</p>
                        <div class="dialog-buttons">
                            <button onclick="document.getElementById('form-dialog').remove()" class="dialog-button dialog-button-secondary">
                                ${messages.rejection.buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(dialog);
      };

      // Show confirmation dialog
      const showConfirmationDialog = () => {
        return new Promise((resolve) => {
          // Remove any existing dialog
          const existingDialog = document.getElementById("form-dialog");
          if (existingDialog) {
            existingDialog.remove();
          }

          // Create confirmation dialog
          const dialog = document.createElement("div");
          dialog.id = "form-dialog";
          dialog.innerHTML = `
                    <div class="dialog-overlay">
                        <div class="dialog-content">
                            <div class="dialog-title">
                                ${messages.confirmation.title}
                            </div>
                            <p class="dialog-message">${messages.confirmation.message}</p>
                            <div class="dialog-buttons">
                                <button id="confirm-yes" class="dialog-button dialog-button-primary">
                                    ${messages.confirmation.confirmText}
                                </button>
                                <button id="confirm-no" class="dialog-button dialog-button-secondary">
                                    ${messages.confirmation.cancelText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          document.body.appendChild(dialog);

          // Add event listeners
          document
            .getElementById("confirm-yes")
            .addEventListener("click", () => {
              resolve(true);
            });

          document
            .getElementById("confirm-no")
            .addEventListener("click", () => {
              resolve(false);
            });
        });
      };

      // Handle form submission with complete processing logic
      const submitFormHandler = async (payload) => {
        // Show confirmation dialog
        const confirmed = await showConfirmationDialog();

        if (!confirmed) {
          showRejectionMessage();
          return;
        }

        // Show progress dialog
        showProgressDialog();

        // Process form fields using extracted functions
        processPayorField(payload);
        processCaregiverField(payload);

        const acesIseligiblediagnosis = payload.fields.find(
          (item) => item.key === "aces_iseligiblediagnosis",
        );

        const acesPayorfound = payload.fields.find(
          (item) => item.key === "aces_payorfound",
        );

        // Use the enhanced fetch function
        try {
          const result = await formFetch(payload);
          if (result.success) {
            console.log("Form submitted successfully", result.data);
            showSuccessMessage(payload);
          } else {
            let errorCode = "";
            if (result.status === 400) {
              if (acesPayorfound && acesPayorfound.value === "0") {
                errorCode = "payer_not_found";
              } else if (
                acesIseligiblediagnosis &&
                acesIseligiblediagnosis.value === "0"
              ) {
                errorCode = "eligibility_diagnosis_not_found";
              } else {
                errorCode = "zip_code_not_found";
              }
              console.log("400 Bad Request - Invalid form data submitted");
            } else {
              errorCode = "unknown_error";
              console.log("An unknown error occurred during form submission");
            }

            // Show error dialog instead of redirecting
            showErrorMessage(errorCode);
          }
        } catch (error) {
          console.error("Unexpected error during form submission:", error);

          // Wait for at least 3 seconds before showing error
          await new Promise((resolve) => setTimeout(resolve, 3000));

          // Show error dialog instead of redirecting
          showErrorMessage("unexpected_error");
        }
      };

      // Make functions available globally for the event handlers
      window.formFetch = formFetch;
      window.processPayorField = processPayorField;
      window.processCaregiverField = processCaregiverField;
      window.submitFormHandler = submitFormHandler;
      window.showConfirmationDialog = showConfirmationDialog;
      window.showProgressDialog = showProgressDialog;
      window.showSuccessMessage = showSuccessMessage;
      window.showErrorMessage = showErrorMessage;
      window.showRejectionMessage = showRejectionMessage;

      // Event listeners for form lifecycle events
      document.addEventListener("d365mkt-beforeformload", function () {
        console.log("d365mkt-beforeformload");
      });

      document.addEventListener("d365mkt-afterformload", function () {
        console.log("d365mkt-afterformload");
      });

      document.addEventListener("d365mkt-formrender", function () {
        console.log("d365mkt-formrender");
      });

      document.addEventListener("d365mkt-formsubmit", function (event) {
        event.preventDefault();
        submitFormHandler(event.detail.payload);
      });

      document.addEventListener("d365mkt-afterformsubmit", function () {});

      // Load the FormLoader script
      const script = document.createElement("script");
      script.src =
        "https://cxppusa1formui01cdnsa01-endpoint.azureedge.net/usa/FormLoader/FormLoader.bundle.js";
      script.defer = true;
      document.head.appendChild(script);
    </script>
  </body>
</html>
